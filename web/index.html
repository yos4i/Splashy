<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Water Gun Control System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }

        .header {
            background: rgba(0, 0, 0, 0.3);
            padding: 1rem;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .status-bar {
            display: flex;
            justify-content: center;
            gap: 2rem;
            margin-top: 0.5rem;
        }

        .status-item {
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .status-active {
            background: rgba(76, 175, 80, 0.8);
        }

        .main-container {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 1rem;
            padding: 1rem;
            height: calc(100vh - 120px);
        }

        .video-panel {
            display: flex;
            flex-direction: column;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 1rem;
        }

        .video-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: black;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .video-stream {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
        }

        .video-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 0.5rem;
            border-radius: 5px;
            font-size: 0.8rem;
        }

        .control-panel {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .control-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 1rem;
        }

        .control-section h3 {
            margin-bottom: 1rem;
            color: #fff;
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
            padding-bottom: 0.5rem;
        }

        .button-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }

        .btn {
            padding: 0.7rem 1rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            text-transform: uppercase;
            font-size: 0.8rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .btn-primary {
            background: #2196F3;
            color: white;
        }

        .btn-success {
            background: #4CAF50;
            color: white;
        }

        .btn-warning {
            background: #FF9800;
            color: white;
        }

        .btn-danger {
            background: #f44336;
            color: white;
        }

        .btn-fire {
            grid-column: span 2;
            background: #FF5722;
            color: white;
            font-size: 1.1rem;
            padding: 1rem;
        }

        .btn-emergency {
            grid-column: span 2;
            background: #E91E63;
            color: white;
            font-size: 1rem;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(233, 30, 99, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(233, 30, 99, 0); }
            100% { box-shadow: 0 0 0 0 rgba(233, 30, 99, 0); }
        }

        .servo-controls {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        .joystick-container {
            display: flex;
            justify-content: center;
            margin: 1rem 0;
        }

        .joystick {
            width: 150px;
            height: 150px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            position: relative;
            background: rgba(0, 0, 0, 0.3);
            cursor: pointer;
        }

        .joystick-knob {
            width: 40px;
            height: 40px;
            background: #2196F3;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.1s ease;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }

        .position-display {
            text-align: center;
            font-size: 0.9rem;
            margin-top: 0.5rem;
            color: #fff;
        }

        .log-panel {
            max-height: 200px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 5px;
            padding: 0.5rem;
        }

        .log-entry {
            padding: 0.3rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.8rem;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-timestamp {
            color: #888;
            margin-right: 0.5rem;
        }

        .log-level-INFO {
            color: #4CAF50;
        }

        .log-level-WARNING {
            color: #FF9800;
        }

        .log-level-ERROR {
            color: #f44336;
        }

        @media (max-width: 768px) {
            .main-container {
                grid-template-columns: 1fr;
                grid-template-rows: 60vh auto;
            }
            
            .status-bar {
                flex-direction: column;
                align-items: center;
                gap: 0.5rem;
            }
            
            .button-grid {
                grid-template-columns: 1fr;
            }
            
            .btn-fire, .btn-emergency {
                grid-column: span 1;
            }
        }

        .connection-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 0.5rem;
            border-radius: 20px;
            font-size: 0.8rem;
            background: #f44336;
            color: white;
        }

        .connection-indicator.connected {
            background: #4CAF50;
        }
    </style>
</head>
<body>
    <div class="connection-indicator" id="connectionStatus">Connecting...</div>
    
    <div class="header">
        <h1>üéØ Water Gun Control System</h1>
        <div class="status-bar">
            <div class="status-item" id="trackingStatus">Tracking: OFF</div>
            <div class="status-item" id="autofireStatus">Auto-fire: OFF</div>
            <div class="status-item" id="servoPosition">Pan: 0¬∞ | Tilt: 0¬∞</div>
        </div>
    </div>

    <div class="main-container">
        <div class="video-panel">
            <div class="video-container">
                <img id="videoStream" class="video-stream" src="/video_feed" alt="Video Stream">
                <div class="video-overlay">
                    <div>FPS: <span id="fpsDisplay">--</span></div>
                    <div>Status: <span id="videoStatus">Loading...</span></div>
                </div>
            </div>
        </div>

        <div class="control-panel">
            <!-- System Controls -->
            <div class="control-section">
                <h3>üéÆ System Control</h3>
                <div class="button-grid">
                    <button class="btn btn-primary" id="toggleTracking">Enable Tracking</button>
                    <button class="btn btn-warning" id="toggleAutofire">Enable Auto-fire</button>
                    <button class="btn btn-fire" id="fireButton">üí¶ FIRE WATER</button>
                    <button class="btn btn-emergency" id="emergencyStop">üö® EMERGENCY STOP</button>
                </div>
            </div>

            <!-- Servo Controls -->
            <div class="control-section">
                <h3>üéõÔ∏è Servo Control</h3>
                <div class="servo-controls">
                    <div class="joystick-container">
                        <div class="joystick" id="joystick">
                            <div class="joystick-knob" id="joystickKnob"></div>
                        </div>
                    </div>
                    <div class="position-display" id="joystickPosition">Pan: 0¬∞ | Tilt: 0¬∞</div>
                    <button class="btn btn-success" id="centerServos">Center Position</button>
                </div>
            </div>

            <!-- Device Controls -->
            <div class="control-section">
                <h3>üí° Devices</h3>
                <div class="button-grid">
                    <button class="btn btn-primary" id="toggleIR">Toggle IR</button>
                    <button class="btn btn-warning" id="deviceStatus">Device Status</button>
                </div>
            </div>

            <!-- System Log -->
            <div class="control-section">
                <h3>üìã System Log</h3>
                <div class="log-panel" id="logPanel">
                    <div class="log-entry">
                        <span class="log-timestamp">--:--:--</span>
                        <span class="log-level-INFO">System initializing...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Socket.IO connection
        const socket = io();
        
        // Connection status
        socket.on('connect', function() {
            document.getElementById('connectionStatus').textContent = 'Connected';
            document.getElementById('connectionStatus').classList.add('connected');
        });

        socket.on('disconnect', function() {
            document.getElementById('connectionStatus').textContent = 'Disconnected';
            document.getElementById('connectionStatus').classList.remove('connected');
        });

        // System state
        let systemState = {
            trackingEnabled: false,
            autofireEnabled: false,
            panDegrees: 0,
            tiltDegrees: 0
        };

        // Status updates
        socket.on('status_update', function(data) {
            if (data.system) {
                systemState.trackingEnabled = data.system.tracking_enabled;
                systemState.autofireEnabled = data.system.auto_fire_enabled;
                updateStatusDisplay();
            }
            
            if (data.servos) {
                systemState.panDegrees = data.servos.pan_degrees;
                systemState.tiltDegrees = data.servos.tilt_degrees;
                updateServoDisplay();
            }
        });

        // Log messages
        socket.on('log_message', function(data) {
            addLogMessage(data);
        });

        function updateStatusDisplay() {
            document.getElementById('trackingStatus').textContent = 
                `Tracking: ${systemState.trackingEnabled ? 'ON' : 'OFF'}`;
            document.getElementById('trackingStatus').classList.toggle('status-active', systemState.trackingEnabled);
            
            document.getElementById('autofireStatus').textContent = 
                `Auto-fire: ${systemState.autofireEnabled ? 'ON' : 'OFF'}`;
            document.getElementById('autofireStatus').classList.toggle('status-active', systemState.autofireEnabled);
            
            document.getElementById('toggleTracking').textContent = 
                systemState.trackingEnabled ? 'Disable Tracking' : 'Enable Tracking';
            document.getElementById('toggleAutofire').textContent = 
                systemState.autofireEnabled ? 'Disable Auto-fire' : 'Enable Auto-fire';
        }

        function updateServoDisplay() {
            document.getElementById('servoPosition').textContent = 
                `Pan: ${systemState.panDegrees}¬∞ | Tilt: ${systemState.tiltDegrees}¬∞`;
        }

        function addLogMessage(data) {
            const logPanel = document.getElementById('logPanel');
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `
                <span class="log-timestamp">${data.timestamp}</span>
                <span class="log-level-${data.level}">${data.message}</span>
            `;
            
            logPanel.appendChild(logEntry);
            logPanel.scrollTop = logPanel.scrollHeight;
            
            // Limit log entries
            while (logPanel.children.length > 50) {
                logPanel.removeChild(logPanel.firstChild);
            }
        }

        // Button event handlers
        document.getElementById('toggleTracking').onclick = function() {
            fetch('/api/tracking/toggle', {method: 'POST'})
                .then(response => response.json())
                .then(data => console.log('Tracking toggled:', data));
        };

        document.getElementById('toggleAutofire').onclick = function() {
            fetch('/api/autofire/toggle', {method: 'POST'})
                .then(response => response.json())
                .then(data => console.log('Auto-fire toggled:', data));
        };

        document.getElementById('fireButton').onclick = function() {
            fetch('/api/fire', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({duration: 1.0})
            })
            .then(response => response.json())
            .then(data => console.log('Fire command:', data));
        };

        document.getElementById('centerServos').onclick = function() {
            fetch('/api/servo/center', {method: 'POST'})
                .then(response => response.json())
                .then(data => console.log('Servos centered:', data));
        };

        document.getElementById('toggleIR').onclick = function() {
            fetch('/api/ir/toggle', {method: 'POST'})
                .then(response => response.json())
                .then(data => console.log('IR toggled:', data));
        };

        document.getElementById('emergencyStop').onclick = function() {
            if (confirm('Are you sure you want to trigger EMERGENCY STOP?')) {
                fetch('/api/emergency_stop', {method: 'POST'})
                    .then(response => response.json())
                    .then(data => console.log('Emergency stop:', data));
            }
        };

        // Joystick control
        let joystickActive = false;
        let joystickCenter = {x: 75, y: 75}; // Center of 150px joystick

        function initJoystick() {
            const joystick = document.getElementById('joystick');
            const knob = document.getElementById('joystickKnob');
            
            function updateJoystick(x, y) {
                const rect = joystick.getBoundingClientRect();
                const centerX = rect.width / 2;
                const centerY = rect.height / 2;
                
                const deltaX = x - centerX;
                const deltaY = y - centerY;
                const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
                const maxDistance = centerX - 20; // Account for knob size
                
                if (distance <= maxDistance) {
                    knob.style.left = x + 'px';
                    knob.style.top = y + 'px';
                } else {
                    const angle = Math.atan2(deltaY, deltaX);
                    const limitedX = centerX + Math.cos(angle) * maxDistance;
                    const limitedY = centerY + Math.sin(angle) * maxDistance;
                    knob.style.left = limitedX + 'px';
                    knob.style.top = limitedY + 'px';
                    x = limitedX;
                    y = limitedY;
                }
                
                // Convert to servo angles (-90 to +90 for pan, -30 to +60 for tilt)
                const panPercent = (x - centerX) / maxDistance;
                const tiltPercent = -(y - centerY) / maxDistance; // Inverted Y
                
                const panAngle = Math.round(panPercent * 90);
                const tiltAngle = Math.round(tiltPercent * 45); // Reduced tilt range
                
                document.getElementById('joystickPosition').textContent = 
                    `Pan: ${panAngle}¬∞ | Tilt: ${tiltAngle}¬∞`;
                
                // Send servo command
                if (joystickActive) {
                    socket.emit('manual_control', {
                        command: 'servo_move',
                        pan: panAngle,
                        tilt: tiltAngle
                    });
                }
            }
            
            function resetJoystick() {
                knob.style.left = '50%';
                knob.style.top = '50%';
                document.getElementById('joystickPosition').textContent = 'Pan: 0¬∞ | Tilt: 0¬∞';
                joystickActive = false;
            }
            
            // Mouse events
            joystick.onmousedown = function(e) {
                joystickActive = true;
                const rect = joystick.getBoundingClientRect();
                updateJoystick(e.clientX - rect.left, e.clientY - rect.top);
            };
            
            document.onmousemove = function(e) {
                if (joystickActive) {
                    const rect = joystick.getBoundingClientRect();
                    updateJoystick(e.clientX - rect.left, e.clientY - rect.top);
                }
            };
            
            document.onmouseup = function() {
                if (joystickActive) {
                    resetJoystick();
                }
            };
            
            // Touch events
            joystick.ontouchstart = function(e) {
                e.preventDefault();
                joystickActive = true;
                const rect = joystick.getBoundingClientRect();
                const touch = e.touches[0];
                updateJoystick(touch.clientX - rect.left, touch.clientY - rect.top);
            };
            
            document.ontouchmove = function(e) {
                if (joystickActive) {
                    e.preventDefault();
                    const rect = joystick.getBoundingClientRect();
                    const touch = e.touches[0];
                    updateJoystick(touch.clientX - rect.left, touch.clientY - rect.top);
                }
            };
            
            document.ontouchend = function() {
                if (joystickActive) {
                    resetJoystick();
                }
            };
        }
        
        // Keyboard shortcuts
        document.onkeydown = function(e) {
            switch(e.key.toLowerCase()) {
                case ' ':
                    e.preventDefault();
                    document.getElementById('fireButton').click();
                    break;
                case 't':
                    document.getElementById('toggleTracking').click();
                    break;
                case 'f':
                    document.getElementById('toggleAutofire').click();
                    break;
                case 'c':
                    document.getElementById('centerServos').click();
                    break;
                case 'i':
                    document.getElementById('toggleIR').click();
                    break;
                case 'escape':
                    document.getElementById('emergencyStop').click();
                    break;
            }
        };

        // Initialize on load
        window.onload = function() {
            initJoystick();
            
            // Fetch initial status
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    if (data.system) {
                        systemState.trackingEnabled = data.system.tracking_enabled;
                        systemState.autofireEnabled = data.system.auto_fire_enabled;
                        updateStatusDisplay();
                    }
                    if (data.servos) {
                        systemState.panDegrees = data.servos.pan_degrees;
                        systemState.tiltDegrees = data.servos.tilt_degrees;
                        updateServoDisplay();
                    }
                });
        };
    </script>
</body>
</html>